name: Vitest Workflow

on:
  push:
    branches:
      - main
      - vitest
      - component-testing
  pull_request:
    branches:
      - main
      - vitest
      - component-testing

jobs:
  build-and-test-app:
    runs-on: ubuntu-latest
    env:
      ACTIONS_RUNNER_DEBUG: true
      ACTIONS_STEP_DEBUG: true
      # Fix for Svelte component testing in JSDOM environment
      NODE_OPTIONS: '--unhandled-rejections=strict'
      # Add testing environment variables
      VITEST_DOM_ENV: 'jsdom'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      # - name: Install DFX
      #   run: |
      #     sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"
      #     echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install DFX
        uses: aviate-labs/setup-dfx@v0.3.2
        with:
          dfx-version: 0.26.0

      - name: Install Mops
        run: npm i -g ic-mops

      - name: Install dependencies
        run: npm install

      - name: Start DFX local replica
        run: dfx start --clean --background

      - name: Create setup file for browser APIs
        run: |
          cat > browser-setup.js << 'EOL'
          // Mock window.matchMedia for tests
          if (typeof window.matchMedia !== 'function') {
            Object.defineProperty(window, 'matchMedia', {
              writable: true,
              value: vi => ({
                matches: false,
                media: vi,
                onchange: null,
                addListener: () => {},
                removeListener: () => {},
                addEventListener: () => {},
                removeEventListener: () => {},
                dispatchEvent: () => {},
              }),
            });
          }
          EOL

      - name: Make deploy script executable
        run: |
          chmod +x ./scripts/deploy-local.sh
          chmod +x ./scripts/deploy-local-ckusdc.sh
          chmod +x ./scripts/deploy-local-usdx.sh
          chmod +x ./scripts/deploy-usdx-index.sh

      - name: Ensure directories exist
        run: |
          mkdir -p .dfx/local
          mkdir -p src/icp-swap/.dfx/local

      - name: Create empty canister_ids.json files if they don't exist
        run: |
          # Create root canister_ids.json if it doesn't exist
          if [ ! -f .dfx/local/canister_ids.json ]; then
            echo '{}' > .dfx/local/canister_ids.json
          fi

          # Create icp-swap canister_ids.json if it doesn't exist
          if [ ! -f src/icp-swap/.dfx/local/canister_ids.json ]; then
            echo '{}' > src/icp-swap/.dfx/local/canister_ids.json
          fi

      - name: Run local deployment
        run: ./scripts/deploy-local.sh
        timeout-minutes: 10
        continue-on-error: true

      - name: Build app
        run: npm run build

      - name: Create temporary setup file for Jest DOM matchers
        run: |
          cat > jest-dom-setup.js << 'EOL'
          import * as matchers from '@testing-library/jest-dom/matchers';
          import { expect } from 'vitest';

          expect.extend(matchers);

          // If using Chai
          import chai from 'chai';
          import { jestDOMChaiMatchers } from '@testing-library/jest-dom/chai-matchers';

          chai.use(jestDOMChaiMatchers);
          EOL

      - name: Display test environment info
        run: |
          echo "Node.js version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo "Checking vitest-setup.ts file:"
          cat vitest-setup.ts
          echo "Checking @testing-library/jest-dom version:"
          npm list @testing-library/jest-dom
          echo "Checking testing-library/svelte version:"
          npm list @testing-library/svelte

      - name: Run tests with special setup
        run: |
          # Run tests with updated configuration
          VITEST_DOM_ENV=jsdom npx vitest run --setupFiles=vitest-setup.ts

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: |
            logs/
            .svelte-kit/
            vitest.config.*
